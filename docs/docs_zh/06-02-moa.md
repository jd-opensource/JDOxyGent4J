# 如何实现多智能体协作？

OxyGent 支持多种多智能体协作模式，包括简单的数量复制、异构智能体协作和层次化智能体管理。

## 1. 简单智能体复制

如果您需要生成多个相同的智能体，您可以使用`teamSize`参数快速复制智能体。

```java
ReActAgent.builder()
    .name("time_agent")
    .desc("A tool for time query")
    .tools(Arrays.asList("time_tools"))
    .llmModel("default_llm")
    .teamSize(2) // 复制2个相同的智能体
    .build()
```

`teamSize`目前仅能复制较为简单的智能体，适合需要并行处理相同任务的场景。

## 2. 异构智能体协作

异构智能体协作是指不同类型的智能体（ChatAgent、ReActAgent、WorkflowAgent等）协同工作，每个智能体具有不同的能力和职责。

```java
// 异构智能体系统示例
List<BaseOxy> oxySpace = Arrays.asList(
    HttpLlm.builder()
        .name("default_llm")
        .apiKey(System.getenv("OXY_LLM_API_KEY"))
        .baseUrl(System.getenv("OXY_LLM_BASE_URL"))
        .modelName(System.getenv("OXY_LLM_MODEL_NAME"))
        .build(),

    // MCP时间工具
    new StdioMCPClient("time", "uvx",
        Arrays.asList("mcp-server-time", "--local-timezone=Asia/Shanghai")),

    // 主智能体 - ReActAgent，负责总体协调
    ReActAgent.builder()
        .isMaster(true)
        .name("master_agent")
        .subAgents(Arrays.asList("QA_agent", "time_agent"))
        .build(),

    // 知识问答智能体 - ChatAgent，专门处理知识类问题
    ChatAgent.builder()
        .name("QA_agent")
        .desc("A tool for knowledge-based questions")
        .build(),

    // 时间查询智能体 - WorkflowAgent，专门处理时间相关任务
    WorkflowAgent.builder()
        .name("time_agent")
        .desc("A tool that can query the time")
        .tools(Arrays.asList("time"))
        .funcWorkflow(oxyRequest -> {
            Map<String, Object> arguments = Map.of("timezone", "Asia/Shanghai");
            Map<String, Object> callRequest = Map.of(
                "callee", "get_current_time",
                "arguments", arguments
            );
            return oxyRequest.call(callRequest).getOutput();
        })
        .build()
);
```

### 异构协作的优势：
- **专业分工**：每个智能体专注于特定领域
- **灵活组合**：可以根据需要组合不同类型的智能体
- **性能优化**：针对不同任务使用最适合的智能体类型

## 3. 层次化智能体管理

层次化智能体管理是指构建多层次的智能体结构，上层智能体管理下层智能体，形成清晰的管理层次。

```java
// 层次化智能体系统示例
List<BaseOxy> oxySpace = Arrays.asList(
    HttpLlm.builder()
        .name("default_llm")
        .apiKey(System.getenv("OXY_LLM_API_KEY"))
        .baseUrl(System.getenv("OXY_LLM_BASE_URL"))
        .modelName(System.getenv("OXY_LLM_MODEL_NAME"))
        .build(),

    // 时间工具
    new StdioMCPClient("time", "uvx",
        Arrays.asList("mcp-server-time", "--local-timezone=Asia/Shanghai")),

    // 文件工具
    new StdioMCPClient("file_tools", "npx",
        Arrays.asList("-y", "@modelcontextprotocol/server-filesystem", "./local_file")),

    // 第二层：专业功能智能体
    ReActAgent.builder()
        .name("time_agent")
        .desc("A tool that can query the time")
        .additionalPrompt("Do not send other information except time.")
        .tools(Arrays.asList("time"))
        .trustMode(false)
        .build(),

    ReActAgent.builder()
        .name("file_tools_agent")
        .desc("A tool for file operations")
        .additionalPrompt("Specialized in file operations.")
        .tools(Arrays.asList("file_tools"))
        .trustMode(false)
        .build(),

    // 第一层：主控智能体
    ReActAgent.builder()
        .isMaster(true)
        .name("master_agent")
        .subAgents(Arrays.asList("time_agent", "file_tools_agent"))
        .build()
);
```

### 层次化管理的优势：
- **清晰职责**：每层智能体有明确的职责划分
- **易于管理**：通过层次结构简化复杂系统的管理
- **可扩展性**：可以轻松添加新的层次或智能体

## 完整的可运行样例

### 异构智能体协作示例

以下是异构智能体协作的完整代码示例（参考 [DemoHeterogeneousAgents.java](../../oxygent-core/src/main/java/com/jd/oxygent/core/oxygent/samples/examples/agent/DemoHeterogeneousAgents.java)）：

```java
package com.jd.oxygent.examples.agent;

import com.jd.oxygent.core.oxygent.oxy.BaseOxy;
import com.jd.oxygent.core.oxygent.oxy.agents.ChatAgent;
import com.jd.oxygent.core.oxygent.oxy.agents.ReActAgent;
import com.jd.oxygent.core.oxygent.oxy.agents.WorkflowAgent;
import com.jd.oxygent.core.oxygent.oxy.llms.HttpLlm;
import com.jd.oxygent.core.oxygent.oxy.mcp.StdioMCPClient;
import com.jd.oxygent.core.oxygent.samples.server.ServerApp;
import com.jd.oxygent.core.oxygent.samples.server.masprovider.engine.annotation.OxySpaceBean;
import com.jd.oxygent.core.oxygent.samples.server.utils.GlobalDefaultOxySpaceMapping;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class HeterogeneousAgentsExample {
    @OxySpaceBean(value = "heterogeneousAgentsOxySpace", defaultStart = true,
                  query = "What time is it? Please also explain what heterogeneous agents are.")
    public static List<BaseOxy> getDefaultOxySpace() {
        return Arrays.asList(
            HttpLlm.builder()
                .name("default_llm")
                .apiKey(System.getenv("OXY_LLM_API_KEY"))
                .baseUrl(System.getenv("OXY_LLM_BASE_URL"))
                .modelName(System.getenv("OXY_LLM_MODEL_NAME"))
                .build(),

            new StdioMCPClient("time", "uvx",
                Arrays.asList("mcp-server-time", "--local-timezone=Asia/Shanghai")),

            // 主智能体 - 负责协调
            ReActAgent.builder()
                .isMaster(true)
                .name("master_agent")
                .subAgents(Arrays.asList("QA_agent", "time_agent"))
                .build(),

            // 知识智能体 - 专门回答概念性问题
            ChatAgent.builder()
                .name("QA_agent")
                .desc("A knowledge-based agent for conceptual questions")
                .build(),

            // 时间智能体 - 专门处理时间查询
            WorkflowAgent.builder()
                .name("time_agent")
                .desc("A specialized agent for time queries")
                .tools(Arrays.asList("time"))
                .funcWorkflow(oxyRequest -> {
                    Map<String, Object> arguments = Map.of("timezone", "Asia/Shanghai");
                    Map<String, Object> callRequest = new HashMap<>();
                    callRequest.put("callee", "get_current_time");
                    callRequest.put("arguments", arguments);
                    return oxyRequest.call(callRequest).getOutput();
                })
                .build()
        );
    }

    public static void main(String[] args) throws Exception {
        GlobalDefaultOxySpaceMapping.searchCurrentThreadStackAnnotationOxySpaceName(
            Thread.currentThread().getStackTrace()[1].getClassName());
        ServerApp.main(args);
    }
}
```

### 层次化智能体管理示例

以下是层次化智能体管理的完整代码示例（参考 [DemoHierarchicalAgents.java](../../oxygent-core/src/main/java/com/jd/oxygent/core/oxygent/samples/examples/agent/DemoHierarchicalAgents.java)）：

```java
package com.jd.oxygent.examples.agent;

import com.jd.oxygent.core.oxygent.oxy.BaseOxy;
import com.jd.oxygent.core.oxygent.oxy.agents.ReActAgent;
import com.jd.oxygent.core.oxygent.oxy.llms.HttpLlm;
import com.jd.oxygent.core.oxygent.oxy.mcp.StdioMCPClient;
import com.jd.oxygent.core.oxygent.samples.server.ServerApp;
import com.jd.oxygent.core.oxygent.samples.server.masprovider.engine.annotation.OxySpaceBean;
import com.jd.oxygent.core.oxygent.samples.server.utils.GlobalDefaultOxySpaceMapping;

import java.util.Arrays;
import java.util.List;

public class HierarchicalAgentsExample {
    @OxySpaceBean(value = "hierarchicalAgentsOxySpace", defaultStart = true,
                  query = "Get the current time and save it to log.txt in the local_file directory")
    public static List<BaseOxy> getDefaultOxySpace() {
        return Arrays.asList(
            HttpLlm.builder()
                .name("default_llm")
                .apiKey(System.getenv("OXY_LLM_API_KEY"))
                .baseUrl(System.getenv("OXY_LLM_BASE_URL"))
                .modelName(System.getenv("OXY_LLM_MODEL_NAME"))
                .build(),

            // 工具配置
            new StdioMCPClient("time", "uvx",
                Arrays.asList("mcp-server-time", "--local-timezone=Asia/Shanghai")),
            new StdioMCPClient("file_tools", "npx",
                Arrays.asList("-y", "@modelcontextprotocol/server-filesystem", "./local_file")),

            // 第二层：功能智能体
            ReActAgent.builder()
                .name("time_agent")
                .desc("Specialized agent for time queries")
                .additionalPrompt("Focus only on time-related tasks.")
                .tools(Arrays.asList("time"))
                .trustMode(false)
                .build(),

            ReActAgent.builder()
                .name("file_tools_agent")
                .desc("Specialized agent for file operations")
                .additionalPrompt("Focus only on file operations.")
                .tools(Arrays.asList("file_tools"))
                .trustMode(false)
                .build(),

            // 第一层：主控智能体
            ReActAgent.builder()
                .isMaster(true)
                .name("master_agent")
                .subAgents(Arrays.asList("time_agent", "file_tools_agent"))
                .build()
        );
    }

    public static void main(String[] args) throws Exception {
        GlobalDefaultOxySpaceMapping.searchCurrentThreadStackAnnotationOxySpaceName(
            Thread.currentThread().getStackTrace()[1].getClassName());
        ServerApp.main(args);
    }
}
```


**参考现有示例**:
- [DemoHeterogeneousAgents.java](../../oxygent-core/src/main/java/com/jd/oxygent/core/oxygent/samples/examples/agent/DemoHeterogeneousAgents.java) - 异构智能体协作实现
- [DemoHierarchicalAgents.java](../../oxygent-core/src/main/java/com/jd/oxygent/core/oxygent/samples/examples/agent/DemoHierarchicalAgents.java) - 层次化智能体管理实现

## 选择合适的协作模式

| 协作模式 | 适用场景 | 优势 | 示例 |
|---------|---------|------|------|
| **简单复制** | 并行处理相同任务 | 实现简单，性能好 | 批量数据处理 |
| **异构协作** | 需要不同专业能力 | 专业分工，灵活组合 | 知识问答+时间查询 |
| **层次化管理** | 复杂任务分解 | 职责清晰，易管理 | 文件处理+时间记录 |

[上一章：创建简单的多agent系统](./06-01-register_multi_agent.md)
[下一章：并行调用agent](./07-01-parallel.md)
[回到首页](./readme.md)